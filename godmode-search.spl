index=* host=* EventCode=* ((EventCode=4624 AND NOT user IN (*$,SYSTEM) AND NOT Account_Name IN (*$,SYSTEM)) OR (EventCode=4634 AND NOT user IN (*$) AND NOT Account_Name IN (*$,SYSTEM)) OR EventCode=410* OR source="WinEventLog:Microsoft-Windows-Sysmon/Operational")
NOT "C:\\ProgramData\\Microsoft\\Windows\\AppRepository\\*" NOT "C:\\Windows\\ServiceState\\EventLog\\Data\\lastalive*" NOT "C:\\Program Files\\WindowsApps\\*" NOT "C:\\Windows\\AppReadiness\\*" NOT "C:\\Windows\\System32\\spool\\*" NOT "C:\\ProgramData\\Packages\\*" NOT "C:\\Windows\\System32\\SearchIndexer.exe" NOT "C:\\System Volume Information\\DFSR\\*" NOT "C:\\ProgramData\\Microsoft\\Diagnosis\\AggregatorStorage\\*" NOT "C:\\ProgramData\\USOPrivate\\UpdateStore\\*" NOT "*ngenofflinequeuelock.dat" NOT "*ngenofflinequeuelock.dat" NOT "C:\\ProgramData\\Microsoft\\Diagnosis\\*" NOT "C:\\Windows\\SystemTemp\\edge_BITS_*" NOT "C:\\ProgramData\\Microsoft\\Windows Defender\\*" NOT "C:\\ProgramData\\Microsoft\\Windows\\WER\\*" NOT "C:\\ProgramData\\USOShared\\*" NOT "C:\\Windows\\SoftwareDistribution\\*" NOT "C:\\Config.Msi\\*" NOT "C:\\Windows\\Microsoft.NET\\Framework64\\*" NOT "C:\\Windows\\SystemTemp\\chrome_Unpacker_BeginUnzipping*" NOT "C:\\Windows\\Temp\\~*.TMP" NOT "C:\\ProgramData\\Package Cache\\*" NOT "C:\\Windows\\Temp\\__PSScriptPolicyTest_*" NOT "C:\\Windows\\SystemTemp\\scoped_dir*" NOT "C:\\Windows\\SystemApps\\Microsoft.*" NOT "C:\\Program Files (x86)\\Microsoft\\Edge*" NOT "C:\\Windows\\Logs\\WindowsUpdate\\WindowsUpdate*" NOT "C:\\Windows\\System32\\sru\\SRUtmp.log" NOT "C:\\ProgramData\\Microsoft\\Windows\\LfSvc\\Geofence*" NOT "C:\\Windows\\PrintDialog\\*" NOT "C:\\Windows\\SystemApps\\*" NOT "C:\\ProgramData\\Microsoft\\Windows\\DeviceMetadataCache\\*" NOT "C:\\Windows\\Logs\\SIH\\*" NOT "C:\\ProgramData\\Microsoft\\Windows\\SystemData\\*" NOT "C:\\ProgramData\\Microsoft\\Windows\\Power Efficiency Diagnostics\\*" NOT "C:\\Windows\\WindowsUpdate.log" NOT "C:\\Windows\\System32\\spp\\store*" NOT "*\\ngen*lock.dat" NOT "C:\\Windows\\security\\templates\\*" NOT "C:\\Windows\\system32\\cleanmgr.exe" NOT "C:\\Windows\\Temp\\SDIAG_*" NOT "upgrade\\tasks\\"
| rex "Host Application\s*=\s*(?<host_application>[^\r\n]+)" | rex "Script Name\s*=\s*(?<script_name>[^\r\n]+)" | eval ps4103 = mvappend(host_application,script_name)
| rex field=Message "Creating Scriptblock text.*:\s*(?<psCommand>[\s\S]*?)\r?\nScriptBlock ID:" | eval psCommand = mvappend(psCommand,ps4103) | eval ConnectionInfo = SourceIp . ":" . SourcePort . " (" . SourceHostname . ") -> " . DestinationIp . ":" . DestinationPort . " (" . DestinationHostname . ")" | eval ConnectionPwrSh = mvappend(ConnectionInfo,psCommand)
| eval myUser = user . " (" . Logon_Type . ")" | eval myUser2 = Account_Name . " (" . Logon_Type . ")" | eval myUser3 =  " --> " . Workstation_Name . "(" . Source_Network_Address . ")" | eval User = mvappend(Account_Name,Logon_Type,User,myUser,myUser2,myUser3)
| table  _time host EventCode User ConnectionPwrSh TargetFilename Image ParentImage CommandLine ParentCommandLine | sort _time
